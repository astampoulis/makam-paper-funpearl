\section{Where our heroes break into song and add more ML
features}\label{where-our-heroes-break-into-song-and-add-more-ml-features}

\begin{scenecomment}
(Our heroes need a small break, so they work on a couple of features while improvising on a makam\footnote{Makam is the system of melodic modes used in traditional Arabic and Turkish music and in the Greek rembetiko, comprised of a set of scales, patterns of melodic development, and rules for improvisation.}. Roza is singing lyrics from the folk songs of her land, and Hagop is playing the oud. Their friend Lambros from next door joins them on the kemenche.)
\end{scenecomment}

\begin{verse}
``System F is easy, / later we might do / Hindley-Milner too. \\
Types are always valid / a `$\vdash \tau \; \text{wf}$' / judgement we won't do.''
\end{verse}

\begin{verbatim}
tforall : (typ \ensuremath{\to} typ) \ensuremath{\to} typ.
lamt : (typ \ensuremath{\to} term) \ensuremath{\to} term.
appt : term \ensuremath{\to} typ \ensuremath{\to} term.
typeof (lamt E) (tforall T) :- (a:typ \ensuremath{\to} typeof (E a) (T a)).
typeof (appt E T) T' :- typeof E (tforall TF), eq T' (TF T).
\end{verbatim}

\begin{verse}
``The algebraic datatypes / caused all sorts of trouble \\
in the previous version / and since it was a double- \\
blind submission process / people do not know yet \\
who the crazy person is / who writes papers in verse.''
\end{verse}

\begin{verbatim}
datadef : type. datatype_bind : (Into: type) \ensuremath{\to} type.
datatype : (Def: datadef) (Rest: datatype_bind program) \ensuremath{\to} program.
\end{verbatim}

\begin{verse}
``The types seem fairly easy / the constructors might be hard. \\
So let's go step by step for now / or we'll be here next March. \\
We won't support the poly-types / to keep the system simple, \\
and arguments to constructors? / They'll all take just a single.''
\end{verse}

\begin{verbatim}
   data nattree = Leaf of nat | Node of (nattree * nattree) ; rest
~> data nattree = [ ("Leaf", nat), ("Node", nattree * nattree) ] ; rest
~> data nattree = [ nat, nattree * nattree ] ; Leaf Node \ensuremath{\Rightarrow} rest
~> data (nattree \ensuremath{\Rightarrow} [nat, nattree * nattree]) ; nattree Leaf Node \ensuremath{\Rightarrow} rest
~> data (nattree \ensuremath{\Rightarrow} [nat, nattree * nattree]) ;
     nattree \ensuremath{\Rightarrow} bind (Leaf Node) \ensuremath{\Rightarrow} body rest
~> datatype (mkdatadef nattree \ensuremath{\Rightarrow} [nat, nattree * nattree]))
     (bind_datatype nattree \ensuremath{\Rightarrow} bind (leaf node) \ensuremath{\Rightarrow} body rest)
\end{verbatim}

\begin{verse}
``Sometimes it just is better / to avoid all those words. \\
Just squint your eyes a little bit / and Hagop'll strum some chords.''
\end{verse}

\begin{verbatim}
mkdatadef : (typ \ensuremath{\to} list typ) \ensuremath{\to} datadef.
constructor : type.
bind_datatype : (typ \ensuremath{\to} bindmany constructor A) \ensuremath{\to} datatype_bind A.
\end{verbatim}

\begin{verse}
``We are avoiding GADTs / they're good, but up the ante. \\
And we have MetaML to do / (in prose 'cause I'm no Dante.) \\
We're almost there, we need to add / the \text{wfprogram} clause. \\
But first we'll need an env. with types that / `constructor`s expose.''
\end{verse}

\begin{verbatim}
constructor_typ : (DataType: typ) (C: constructor) (ArgType: typ) \ensuremath{\to} prop.
\end{verbatim}

\begin{verse}
``We go through the constructors / populating our new \text{prop}. \\
\text{DT} stands for datatype / -- the page size's just too cropped.''
\end{verse}

\begin{verbatim}
wfprogram (datatype (mkdatadef DT_ConstrArgTypes)
                    (bind_datatype DT_Constrs_Rest)) :-
  (dt:typ \ensuremath{\to} openmany (DT_Constrs_Rest dt) (pfun constrs rest \ensuremath{\Rightarrow}
    assumemany (constructor_typ dt) constrs (DT_ConstrArgTypes dt)
    (wfprogram rest))).
\end{verbatim}

\begin{verse}
``That's it, we're almost over / there's our wf-programs. \\
We can't use the constructors though / remember \text{term}s and \text{patt}s ?''
\end{verse}

\begin{verbatim}
constr : (C: constructor) (Arg: term) \ensuremath{\to} term.
patt_constr : (C: constructor) (Arg: patt N N') \ensuremath{\to} patt N N'.
typeof (constr C Arg) Datatype :-
  constructor_typ Datatype C ArgType, typeof Arg ArgType.
typeof_patt (patt_constr C Arg) Datatype S S' :-
  constructor_typ Datatype C ArgType, typeof_patt Arg ArgType S S'.
\end{verbatim}

\begin{verse}
``That's all, there's no example / but if you download Makam \\
trust me: you can run this code / and check that all tests pass.''
\end{verse}
